<!DOCTYPE html>
<html lang="en">

<head>
  <!-- meta data -->
  <meta charset="UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Cool little chat program written with Node and Socket.IO">
  <meta name="keywords" content="Node.js, Socket.IO, WebSockets, Chat, Code">
  <meta name="author" content="Nazaire Shabazz">

  <!-- Socket.IO JS ContentDeliveryNetwork -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.min.js"></script>

  <!-- JQuery JS ContentDeliveryNetwork -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

  <!-- Bootstrap CSS ContentDeliveryNetwork -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">


  <!-- Bootstrap Tooltips Tether JS ContentDeliveryNetwork -->
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"
    integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb"
    crossorigin="anonymous"></script> -->

  <!-- Bootstrap JS ContentDeliveryNetwork -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
    crossorigin="anonymous"></script>


  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">

  <link rel="stylesheet" href="assets/css/style.css">

  <title>Basic Node Chat</title>
</head>

<body class="container">
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="https://nqshabazz.com">
          <img class="img-responsive" alt="logo" src="assets/img/LOGO_sm.png">
        </a>
      </div>
    </div>
  </nav>

  <main>
    <div class="navbar">
      <h1 class="text-white">Server Chat</h1>
      <p class="text-warning"><span id="connectionStatus">&#9679; connecting...</span></p>
    </div>

    <div id="messageContainer"></div>

    <div class="input-group">
      <input type="text" class="form-control" id="message-input" placeholder="Send a message">
      <span class="input-group-btn">
        <button class="btn btn-primary" type="button" onclick="sendMessage()">Send!</button>
      </span>
    </div>

    <br />
    <i>/help</i>

    <div class="modal fade" id="myModal" tab-index='-1' aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-body">
            <p id="loginStatus"></p>
            <input type="text" class="form-control" id="username-input" placeholder="Choose a username">
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const socket = io()//'https://basic-node-chat.nqshabazz.com:1025/');
    const usernameInput = document.querySelector('#username-input')
    const messageInput = document.querySelector('#message-input')
    const messageContainer = document.querySelector('#messageContainer')
    const commandHistory = []

    let commandIndex = 0
    let uID = localStorage && localStorage.getItem('node-chat-userID')
    
    function sendMessage(message) {
      socket.emit('message', message)

      commandHistory[commandHistory.length - 1] = message
      commandHistory.push('')

      commandIndex = commandHistory.length - 1
    }

    function addMessage(m, isServer) {
      const id = Date.now() + Math.random().toString(16).substr(2, 8)
      const stickToBottom = messageContainer.scrollTop >= messageContainer.scrollHeight - messageContainer.offsetHeight;

      isServer ?
        messageContainer.innerHTML += `<span class='text-center' id='${id}'>${m}</span>`
        : messageContainer.innerHTML += `
          <span>
            ${m.sender}
            <span class="mini">#${m.uID}</span> | <time datetime="${Date.now()}">${(new Date().toLocaleTimeString())}</time>
          </span>
          <p id="${id}"${(m.uID === uID ? ' class="myMessage"' : '')}>
            ${m.message}
          </p>`

      m.yelling && document.getElementById(id).classList.add('yelling')

      if (stickToBottom) messageContainer.scrollTop = messageContainer.scrollHeight
    }

    $(document).ready(() => {
      $('#myModal').modal({ backdrop: 'static', keyboard: false })
      $('#myModal').on('shown.bs.modal', () => usernameInput.focus())

      socket.on('login_fail', m => {
        document.querySelector('#loginStatus').classList.add('text-danger')
        document.querySelector('#loginStatus').classList.remove('invisible')
        document.querySelector('#loginStatus').innerHTML = m
      })
      socket.on('authenticated', m => {
        document.querySelector('#connectionStatus').classList.remove('text-warning')
        document.querySelector('#connectionStatus').classList.add('text-success')
        document.querySelector('#connectionStatus').innerHTML = '&#9679; online'

        $('#myModal').modal('hide')
        messageInput.focus()

        localStorage.setItem('node-chat-userID', m.id)
        socket.confirmed = true
      })
      socket.on('reconnect_fail', () => {
        localStorage.removeItem('node-chat-userID')
        $('#myModal').modal('show')
      })
      socket.on('server_notif', m => addMessage(m, 1))
      socket.on('message', m => addMessage(m))

      uID ? socket.emit('reconnect', uID) : $('#myModal').modal('show')

      usernameInput.addEventListener('keyup', (event) => {
        document.querySelector('#loginStatus').classList.remove('text-danger')
        document.querySelector('#loginStatus').classList.add('invisible')

        event.key === 'Enter' && socket.emit('login', { username: usernameInput.value })
      })

      messageInput.addEventListener('keydown', event => {
        if (event.key === 'Enter') {
          sendMessage(messageInput.value)
          messageInput.value = ''
        } else if (event.key === 'ArrowUp' && messageInput.selectionStart === 0)
          messageInput.value = commandHistory[commandIndex = Math.max(0, --commandIndex)]
        else if (event.key === 'ArrowDown' && messageInput.selectionStart === messageInput.value.length)
          messageInput.value = commandHistory[commandIndex = Math.min(commandHistory.length - 1, ++commandIndex)]
        else
          commandHistory[commandIndex] = messageInput.value
      })
    })
  </script>
</body>

</html>