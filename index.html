<!DOCTYPE html>
<html>

<head>
  <!-- Socket.IO JS ContentDeliveryNetwork -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>

  <!-- JQuery JS ContentDeliveryNetwork -->
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>

  <!-- Bootstrap CSS ContentDeliveryNetwork -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">

  <!-- Bootstrap Tooltips Tether JS ContentDeliveryNetwork -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>

  <!-- Bootstrap JS ContentDeliveryNetwork -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">

  <link rel="stylesheet" href="assets/css/style.css">
  
  <title>Basic Node Chat</title>
</head>

<body class="container">
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="https://nqshabazz.com">
          <img class="img-responsive" alt="logo" src="assets/img/LOGO_sm.png">
        </a>
      </div>
    </div>
  </nav>

  <main>
    <div class="navbar">
      <h1 class="text-white">Server Chat</h1>
      <p class="text-warning"><span id="connectionStatus">&#9679; connecting...</span></p>
    </div>

    <div id="messageContainer"></div>

    <div class="input-group">
      <input type="text" class="form-control" id="typeBox" placeholder="Send a message">
      <span class="input-group-btn">
        <button class="btn btn-primary" type="button" onclick="sendMessage()">Send!</button>
      </span>
    </div>

    <div class="modal fade" id="myModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-body">
            <p id="loginStatus"></p>
            <input type="text" class="form-control" id="usernameBox" placeholder="Choose a username">
          </div>
        </div>
      </div>
    </div>
  </main>
  <script>
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    const oscillator = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    let socket = io('http://198.211.110.180:1025/');
    let usernameBox = document.querySelector('#usernameBox');
    let typeBox = document.querySelector('#typeBox');
    let messageContainer = document.querySelector('#messageContainer');
    let myUID = null;
    let username = "USER " + Date.now();
    let lastSender = "";

    socket.confirmed = false;

    function addMessage(m) {
      let id = Date.now() + m.uID;
      messageContainer.innerHTML += "<span>" + m.sender + " <span class='mini'>#" + m.uID + "</span> | <time datetime='" + Date.now() + "'>" + (new Date().toLocaleTimeString()) + "</time></span>" + "<p id='" + id + "'" + (m.uID === myUID ? " class='myMessage'" : "") + ">" + m.message + "</p>";
      document.getElementById(id).innerText = m.message;
      
      if(m.yelling)
        document.getElementById(id).classList.add("yelling");
      
      lastSender = m.uID;
    }

    function sendMessage() {
      if (typeBox.value.trim() !== "") {
        socket.emit("message", {
          message: typeBox.value
        });
        typeBox.value = "";
      }
    }

    socket.on("new_message", function(m) {
      let stickToBottom = messageContainer.scrollTop >= messageContainer.scrollHeight - messageContainer.offsetHeight;

      addMessage(m);

      if (stickToBottom)
        messageContainer.scrollTop = messageContainer.scrollHeight;

      if (!document.hasFocus()) {
        gain.gain.value = 0.5;
        gain.connect(audioCtx.destination);
        lowerVolume();
      }
    });

    socket.on('server_notif', function(m) {
      let stickToBottom = messageContainer.scrollTop >= messageContainer.scrollHeight - messageContainer.offsetHeight;

      if (m.message === "login_fail") {
        document.querySelector('#loginStatus').classList.add("text-danger");
        document.querySelector('#loginStatus').classList.remove("invisible");
        document.querySelector('#loginStatus').innerHTML = m.message + ": " + m.reason;

        return;
      }else if (m.message === "login_success") {
        document.querySelector('#connectionStatus').classList.remove("text-warning");
        document.querySelector('#connectionStatus').classList.add("text-success");
        document.querySelector('#connectionStatus').innerHTML = "&#9679; online";
        $("#myModal").modal("hide");

        username = m.reason;
        socket.confirmed = true;
      }else
        messageContainer.innerHTML += "<span class='text-center'>" + m.message + "</span>";

      if (stickToBottom)
        messageContainer.scrollTop = messageContainer.scrollHeight;
    });

    $(document).ready(() => {
      if (localStorage) {
        if (localStorage.getItem("uID") === null)
          localStorage.setItem("uID", +("" + Date.now() + ((Math.random() * 1000) | 0)));

        myUID = localStorage.getItem("uID");

        usernameBox.addEventListener('keyup', (event) => {
          document.querySelector('#loginStatus').classList.remove("text-danger");
          document.querySelector('#loginStatus').classList.add("invisible");

          if (!socket.confirmed && usernameBox.value.trim() !== "" && event.key === 'Enter')
            socket.emit("login", {
              uID: myUID,
              message: usernameBox.value
            });
        });

        typeBox.addEventListener('keyup', (event) => {
          if (event.key === 'Enter')
            sendMessage();
        });

        $("#myModal").modal({
          backdrop: 'static'
        });

        oscillator.connect(gain);
        gain.connect(audioCtx.destination);

        oscillator.frequency.value = 250;
        oscillator.type = 'triangle';
        oscillator.start(0);
        gain.gain.value = 0;
      } else {
        alert("Your browser does not support localstorage, which is necessary for authentication");
      }
    });

    function lowerVolume() {
      if (gain.gain.value > 0) {
        gain.gain.value = Math.max(0, gain.gain.value - 0.05);
        setTimeout(lowerVolume, 25);
      } else {
        gain.gain.value = 0;
        gain.disconnect(audioCtx.destination);
      }
    }
  </script>
</body>

</html>